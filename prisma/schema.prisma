generator erd {
  provider = "prisma-erd-generator"
}
// datasourceì™€ generatorëŠ” Prismaê°€ ìë™ìœ¼ë¡œ ì„¤ì •
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// --- ì—¬ê¸°ë¶€í„° ëª¨ë¸ ì •ì˜ ì‹œì‘ ---

model User {
  user_id             Int       @id @default(autoincrement())
  username            String    @unique @db.VarChar(255)
  email               String    @unique @db.VarChar(255)
  password_hash       String
  explorer_level      Int       @default(1)
  experience_points   Int       @default(0)

  // ğŸ”¥ ì‹ ê·œ
  points              Int       @default(0)          // ëˆ„ì  í¬ì¸íŠ¸(ê°ì†Œ í—ˆìš©)
  title               String    @default("ì´ˆì‹¬ì")   // ì¹­í˜¸(í¬ì¸íŠ¸ êµ¬ê°„ ìë™ ë°˜ì˜)
  assets              Int[]     @default([])         // ë³´ìœ  ì—ì…‹ id ë¦¬ìŠ¤íŠ¸(ìµœëŒ€ 3ê°œëŠ” ì„œë¹„ìŠ¤ì—ì„œ ê²€ì¦)
  current_character_id Int?
  is_public_profile   Boolean   @default(true)
  created_at          DateTime  @default(now()) @db.Timestamptz(3)

  // ê¸°ì¡´
  currentCharacter  Character?    @relation("CurrentUserCharacter", fields: [current_character_id], references: [character_id])
  onboarding_answers Json?

  quests         Quest[]
  journeys       Journey[]
  logbookEntries LogbookEntry[]
  likes          Like[]
  scraps         Scrap[]
  characters     UserCharacter[]   // ë³´ìœ  ìºë¦­í„°ëŠ” ê³„ì† ê´€ê³„ í…Œì´ë¸”ë¡œ ê´€ë¦¬(ê¶Œí•œ/ì¤‘ë³µ ë°©ì§€)
  reviews        Review[]
  locationLikes  LocationLike[]
}

model Character {
  character_id   Int             @id @default(autoincrement())
  character_name String          @db.VarChar(255)
  description    String?         @db.Text
  image_url      String?         @db.VarChar(255)
  unlock_level   Int
  is_premium     Boolean         @default(false)

  unlockedByUsers UserCharacter[]
  currentUsers    User[]          @relation("CurrentUserCharacter")
}

model UserCharacter {
  user_character_id Int      @id @default(autoincrement())
  user_id           Int
  character_id      Int
  unlocked_at       DateTime @default(now()) @db.Timestamptz(3)

  user      User     @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  character Character @relation(fields: [character_id], references: [character_id], onDelete: Cascade)

  @@unique([user_id, character_id])
}

model Quest {
  quest_id       Int      @id @default(autoincrement())
  user_id        Int
  title          String
  is_main_quest  Boolean  @default(false)
  is_completed   Boolean  @default(false)
  reward_exp     Int      @default(0)

  // ğŸ”¥ ì‹ ê·œ
  reward_points  Int      @default(0)  // í€˜ìŠ¤íŠ¸ í¬ì¸íŠ¸ ë³´ìƒ

  user User @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
}

model Location {
  location_id        Int       @id @default(autoincrement())
  location_name      String
  address            String?
  latitude           Decimal?   @db.Decimal(9, 6)
  longitude          Decimal?   @db.Decimal(9, 6)
  category           String?
  is_solo_friendly   Boolean   @default(true)
  description        String?   @db.Text

  rating_avg         Decimal?  @db.Decimal(3, 2)
  rating_count       Int?
  price_level        Int?
  keywords           String[]
  features           Json?
  features_flat  String[] @default([])  // ê²€ìƒ‰ìš© ë¯¸ëŸ¬
  opening_hours      Json? 

  google_place_id      String?  @unique
  photo_reference      String?  // Google Places Photo reference (ëŒ€í‘œ 1ì¥)
  photo_attribution    Json?    // [{author_name, author_url}] ë“±
  fallback_photo_url   String?  // ë„¤ì´ë²„ ë“±ì—ì„œ í™•ë³´í•œ ë°±ì—…ìš© ëŒ€í‘œ ì´ë¯¸ì§€ URL(ì„ íƒ)
  thumbnail_url        String?  // ì„œë²„ì—ì„œ ì¸ë„¤ì¼ ìƒì„± ì‹œ ì €ì¥(ì„ íƒ)

  dedupe_signature   String?   @unique
  created_at         DateTime  @default(now())
  updated_at         DateTime  @updatedAt

  photos             LocationPhoto[]

  journeys           JourneyLocation[]
  logbookEntries     LogbookEntry[]

  reviews Review[]

  likesByUsers       LocationLike[]
  
  @@index([latitude, longitude])
}

model LocationLike {
  like_id     Int      @id @default(autoincrement())
  user_id     Int
  location_id Int
  created_at  DateTime @default(now()) @db.Timestamptz(3)

  user        User     @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  location    Location @relation(fields: [location_id], references: [location_id], onDelete: Cascade)

  @@unique([user_id, location_id]) // ìœ ì €-ì¥ì†Œ 1íšŒë§Œ ì¢‹ì•„ìš”
  @@index([user_id])
  @@index([location_id])
}

model LocationPhoto {
  id               Int       @id @default(autoincrement())
  location_id      Int
  position         Int       // 1..3 (ëŒ€í‘œ ìˆœì„œ)
  width            Int?
  height           Int?
  photo_reference  String    // Google Places Photo reference
  attributions     String[]  // html_attributions ë¬¸ìì—´ ë°°ì—´
  remote_url       String?   // photo endpoint URL (maxwidth ë“± í¬í•¨í•œ ìš”ì²­ URL)
  created_at       DateTime  @default(now())
  updated_at       DateTime  @updatedAt

  location         Location  @relation(fields: [location_id], references: [location_id], onDelete: Cascade)

  @@unique([location_id, position])
  @@index([location_id])
}

model Journey {
  journey_id    Int               @id @default(autoincrement())
  user_id       Int
  journey_title String
  created_at    DateTime          @default(now()) @db.Timestamptz(3)
  tags          String[]

  user      User              @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  locations JourneyLocation[]
  logbookEntries LogbookEntry[]
}

model JourneyLocation {
  journey_location_id Int @id @default(autoincrement())
  journey_id          Int
  location_id         Int
  sequence_number     Int

  journey  Journey  @relation(fields: [journey_id], references: [journey_id], onDelete: Cascade)
  location Location @relation(fields: [location_id], references: [location_id], onDelete: Cascade)
}

model LogbookEntry {
  logbook_id    Int      @id @default(autoincrement())
  user_id       Int
  journey_id    Int?
  location_id   Int?
  entry_title   String
  entry_content String?  @db.Text
  is_public     Boolean  @default(true)
  created_at    DateTime @default(now()) @db.Timestamptz(3)
  image_urls    Json?    @db.JsonB

  user     User     @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  journey  Journey? @relation(fields: [journey_id], references: [journey_id], onDelete: SetNull)
  location Location?@relation(fields: [location_id], references: [location_id], onDelete: SetNull)
  likes    Like[]
  scraps   Scrap[]

  review Review[]
}

model Like {
  like_id    Int      @id @default(autoincrement())
  logbook_id Int
  user_id    Int
  created_at DateTime @default(now()) @db.Timestamptz(3)

  logbookEntry LogbookEntry @relation(fields: [logbook_id], references: [logbook_id], onDelete: Cascade)
  user         User         @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@unique([logbook_id, user_id])
}

model Scrap {
  scrap_id   Int      @id @default(autoincrement())
  logbook_id Int
  user_id    Int
  created_at DateTime @default(now()) @db.Timestamptz(3)

  logbookEntry LogbookEntry @relation(fields: [logbook_id], references: [logbook_id], onDelete: Cascade)
  user         User         @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@unique([logbook_id, user_id])
}

model Review {
  review_id   Int      @id @default(autoincrement())
  user_id     Int
  location_id Int
  logbook_id  Int

  rating      Int      
  content     Json     
  
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  user        User         @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  location    Location     @relation(fields: [location_id], references: [location_id], onDelete: Cascade)
  logbook     LogbookEntry @relation(fields: [logbook_id], references: [logbook_id], onDelete: Cascade)

  @@unique([logbook_id, location_id])
}